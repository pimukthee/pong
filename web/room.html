<!doctype html>
<html>
  <head>
    <title>Pong</title>
    <meta charset="UTF-8" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }

      body {
        background: black;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <canvas width="750" height="585" id="game"></canvas>
    <script>
      var conn;
      var id;
      var side;
      var action;
      var playerPaddle;
      var opponentPaddle;

      if (window["WebSocket"]) {
        pathnames = window.location.pathname.split("/");
        roomId = pathnames.pop() || pathnames.pop();
        conn = new WebSocket(
          "ws://" + document.location.host + "/ws/" + roomId,
        );
        conn.onclose = function (evt) {
          console.log("player left");
        };
        conn.onmessage = function (evt) {
          // first message
          if (id == null) {
            msg = JSON.parse(evt.data);
            id = msg.id;
            side = msg.side;
            playerPaddle = side ? leftPaddle : rightPaddle;
            opponentPaddle = side ? rightPaddle : leftPaddle;
            
            draw()
          } else {
            action = JSON.parse(evt.data);
            syncServer();
          }
        };
      } else {
        alert("Your browser does not support WebSockets.");
      }

      function syncServer() {
        leftPaddle.dy = action.player1.dy;
        leftPaddle.y = action.player1.y;
        rightPaddle.y = action.player2.y;
        rightPaddle.dy = action.player2.dy;

        playerPaddle = side ? leftPaddle : rightPaddle;
        opponentPaddle = side ? rightPaddle: leftPaddle;
      }

      const canvas = document.getElementById("game");
      const context = canvas.getContext("2d");
      const grid = 15;
      const paddleHeight = grid * 5;
      const maxPaddleY = canvas.height - grid - paddleHeight;
      const Arrows = {
        Up: 38,
        Down: 40,
      };
      const acceleration = 3;
      const maxSpeed = 6;
      const ballSpeed = 5;

      const ball = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        dx: -ballSpeed,
        dy: 3,
        width: grid,
        height: grid,
      };
      const leftPaddle = {
        x: grid * 2,
        y: canvas.height / 2 - paddleHeight / 2, // top of the paddle
        width: grid,
        height: paddleHeight,
        acceleratingUp: false,
        acceleratingDown: false,
        dy: 0,
      };
      const rightPaddle = {
        x: canvas.width - grid * 3,
        y: canvas.height / 2 - paddleHeight / 2,
        width: grid,
        height: paddleHeight,
        acceleratingUp: false,
        acceleratingDown: false,
        dy: 0,
      };

      function draw() {
        context.clearRect(0, 0, canvas.width, canvas.height);

        moveBall();
        updatePlayerPaddleSpeed();
        movePlayerPaddle();

        context.fillStyle = "white";
        context.fillRect(ball.x, ball.y, ball.width, ball.height);
        context.fillRect(
          playerPaddle.x,
          playerPaddle.y,
          playerPaddle.width,
          playerPaddle.height,
        );
        context.fillRect(
          opponentPaddle.x,
          opponentPaddle.y,
          opponentPaddle.width,
          opponentPaddle.height,
        );

        context.fillstyle = "lightgrey";
        context.fillRect(0, 0, canvas.width, grid);
        context.fillRect(0, canvas.height - grid, canvas.width, canvas.height);

        for (let i = grid; i < canvas.height - grid; i += grid * 2) {
          context.fillRect(canvas.width / 2 - grid / 2, i, grid, grid);
        }
        requestAnimationFrame(draw);
      }

      function moveBall() {
        const newY = ball.y + ball.dy;
        const newX = ball.x + ball.dx;

        // bounce horizontal boundaries
        if (newY >= grid && newY <= canvas.height - 2 * grid) {
          ball.y = newY;
          ball.x = newX;
        } else {
          ball.dy *= -1;
          ball.x = newX;
        }

        // bounce vertical boundaries
        if (newX >= 0 && newX <= canvas.width - grid) {
          ball.y = newY;
          ball.x = newX;
        } else {
          ball.dx *= -1;
          ball.y = newY;
        }
      }

      function getPlayers(action) {
        if (action.player1.id === id) {
          return [action.player1, action.player2];
        }

        return [action.player2, action.player1];
      }

      function movePlayerPaddle() {
        const newY = playerPaddle.y + playerPaddle.dy;
        if (newY <= maxPaddleY && newY >= grid) {
          playerPaddle.y = newY;
        }
      }

      document.addEventListener("keydown", function (e) {
        if (e.which === Arrows.Up) {
          if (!playerPaddle.acceleratingUp) {
            playerPaddle.acceleratingUp = true;
            sendAction();
          }
        } else if (e.which == Arrows.Down) {
          if (!playerPaddle.acceleratingDown) {
            playerPaddle.acceleratingDown = true;
            sendAction();
          }
        }
      });

      document.addEventListener("keyup", function (e) {
        if (e.which == Arrows.Up) {
          if (playerPaddle.acceleratingUp) {
            playerPaddle.acceleratingUp = false;
            sendAction();
          }
        } else if (e.which == Arrows.Down) {
          if (playerPaddle.acceleratingDown) {
            playerPaddle.acceleratingDown = false;
            sendAction();
          }
        }
      });

      function updatePlayerPaddleSpeed() {
        if (playerPaddle.acceleratingUp && !playerPaddle.acceleratingDown) {
          playerPaddle.dy = Math.max(-maxSpeed, playerPaddle.dy - acceleration);
        } else if (
          playerPaddle.acceleratingDown &&
          !playerPaddle.acceleratingUp
        ) {
          playerPaddle.dy = Math.min(maxSpeed, playerPaddle.dy + acceleration);
        } else if (
          !playerPaddle.acceleratingUp &&
          !playerPaddle.acceleratingDown
        ) {
          if (playerPaddle.dy > 0) {
            playerPaddle.dy -= acceleration;
          } else if (playerPaddle.dy < 0) {
            playerPaddle.dy += acceleration;
          }
        }
      }

      function sendAction() {
        conn.send(
          JSON.stringify({
            up: playerPaddle.acceleratingUp,
            down: playerPaddle.acceleratingDown,
          }),
        );
      }
    </script>
  </body>
</html>
